<h1>
  <p align="center" width="100%">
	<img width="22%" src="../.recursos/img/logos/traefik.png">
	</br>
	Træfik v3
  </p> 
</h1>

<h2> 
  <p align="center" width="100%">
	A reverse proxy with SSL certificates to redirect incoming requests to their respective services through HTTPS
  </p>
</h2>

<h3>
  <p align="left" width="100%">
	Based on the image from <a href="https://traefik.io">Træfik</a>: <a href="https://github.com/traefik/traefik">traefik</a>
  </p>
</h3>

[![Static Badge](https://img.shields.io/badge/lang-%F0%9F%87%AA%F0%9F%87%B8_es-blue?style=plastic)](README.es.md)

<h3>
  Content:
</h3>

- [Structure](#structure)
- [Explanation](#explanation)
	- [*Wait... What is a Middleware?*](#wait-what-is-a-middleware)
	- [*And a chain?*](#and-a-chain)
	- [*Basic authentication (for now)*](#basic-authentication-for-now)
	- [*Other remarks*](#other-remarks)
	- [*Environment variables*](#environment-variables)
	- [*Before starting*](#before-starting)
		- [*Obtaining the Cloudflare API token*](#obtaining-the-cloudflare-api-token)
- [Container start](#container-start)

## Structure

	traefik/
	  ├─ docker-compose.yml                   → dockerfile
	  ├─ .env                                 → environment variables
	  ├─ traefik.yml                          → static configuration
	  ├─ acme/
	  │    └─ acme.json                       → SSL certificate
	  ├─ logs/
	  │    ├─ access.log                      → access log
	  │    └─ traefik.log                     → application log
	  └─ rules/                               → dynamic configuration
	       ├─ external.yml                    → redirection to non-docker services
	       ├─ middlewares.yml                 → middlewares (see below)
	       ├─ middlewares-chains.yml          → chained middlewares (see below)
	       └─ tls-opts.yml                    → TLS options

## Explanation

The `docker-compose.yml` and `.env` files need no introduction, these are the files that contain all the instructions and variables to create the Traefik container.

The `traefik.yml` file contains the **_"static"_** Traefik configuration, that is, the configuration that does not change over time (or changes very rarely).

The `acme/` folder containing the `acme.json` file is where the SSL certificates generated by Let's Encrypt are stored. This file has special treatment, since we must create it manually and assign read and write permissions **only** to the user running the Traefik container, using `chmod 600 acme.json`

The `logs/` folder contains the access log file `access.log` and the Traefik application log file `traefik.log`. We can work without them, but it's recommended to have them on hand to debug problems or use them for other containers such as [**crowdsec**](../crowdsec), to look for suspicious behavior patterns. These files will also have to be created manually, since Docker is only capable of creating directories if necessary, but not files.

Finally, the `rules/` folder contains Traefik's **_"dynamic"_** configuration. Dynamic in the sense that each file we drop inside will be read by Traefik and will apply the configuration inmediately. And dynamic in the sense that we can create new services (or delete them) with some regularity, as it's very likely to happen in a Homelab environment, so we can alter the rules whenever we want. Let's first talk about `external.yml` and `tls-opts.yml`, which are easier to explain.

* `external.yml`: Contains rules for redirecting incoming requests to services that are not Docker containers. For example, if we have a web service on a remote server, we can tell Traefik through these rules where each request should go. This file is actually an example of how to do it, since we can create a file for each service, one for all services, or a combination of both.
* `tls-opts.yml`: Contains a set of commonly used TLS options.

Among all the files inside `rules/` there are two that are of special importance: `middlewares` and `middlewares-chains`.

### *Wait... What is a Middleware?*

Middlewares are pieces of code that are inserted between the request and the service. They are a way of "intercepting" requests and making changes to them, which are usually necessary in order to make the target service work.

### *And a chain?*

Services often use the same middlewares over and over again. A chain is a way of grouping them under the same name and thus applying them jointly to the service. Then we can specify the chain we want to be applied through Traefik labels.

### *Basic authentication (for now)*

We are not going to expose our traefik dashboard to anyone, so for now and until we set up a better authentication system ([Authelia](../authelia/)), we are going to use basic authentication.

We are going to create a file in a safe place with a username:password pair inside. If we want to add more users then write a line for each one.

The password has to be encrypted with the MD5, SHA1 or BCrypt standards. Although we can do it ourselves, from experience I've found that it is better to use the `htpasswd` utility that comes included with Apache2, or an online version if we don't want to install anything. Also it's supposed to be a temporary way to protect the dashboard until we configure Authelia, so don't worry too much about it.

So, if our user is `user` and the password is `PASSWORD`, write in the file the user name followed by a colon and then the encrypted password **without leaving spaces between any of them.**

```
user:PASSWORD becomes:

user:$apr1$akhbl7id$BDDd7dzu.xFfgUBPTYFTY1
```
>

Finally write the path to the file inside `middlewares.yml`:

```yaml
http:
  middlewares:
    middlewares-basic-auth:
      basicAuth:
        usersFile: "/path/secure/file/.users"
```

### *Other remarks*

As we've seen, using the `rules/` folder allows us to drop files into it and have Traefik read and apply them on the fly. But this is not true for any subfolders we make inside, so it's not recursive. If we like to have everything organized and grouped by folders, it won't work.

In the `traefik.yml` file, lines 79 and 80 define the Let's Encrypt server adresses. The first one is the staging server and the second one is the production server. During the first startup, and until we see that we can obtain a certificate (`cat acme/acme.json`) we must have the staging server uncommented and the production one commented. This is because the production server has a counter of attempts and if we have many failures in a row we can be banned for a few hours (or even days). The staging server issues a certificate that, although it's not valid, certainly allows us to test that everything works correctly before requesting the actual certificate. Once we have obtained the certificate, we can comment the staging server and uncomment the production one.

The container uses [socket-proxy](../socket-proxy/) for added security, but there are the necessary lines (commented) to work without it.

It uses [Cloudflare](cloudflare.com) as a DNS resolver, but it is possible to use any other.

### *Environment variables*

* `PUID` y `PGID` are the user and group identifiers in numeric format (run `id` to find out)
* `TZ` is the time zone in `Continent/City` format. [List of zones](https://www.joda.org/joda-time/timezones.html)
* `DOCKERDIR` is the parent directory containing all Docker services.
* `DOMAINNAME` is the name of our domain.
* `CLOUDFLARE_EMAIL` is the email address with which we registered the domain with Cloudflare.
* `CF_DNS_API_TOKEN` is an identifier to prove that we own the domain and thus obtain the certificates.

### *Before starting*

* Create the folders and files structure indicated above, paying special attention to `acme.json`'s permissions. **If they are not 600 (rw- --- ---) Traefik won't start.**

* The `proxy` network must be present before starting the Traefik container. You can comment out the `external: true` line in `docker-compose.yml` and Traefik will create it automatically, but this has the drawback that if the container fails or is not running, the other services that rely on it will also go down. That is why it's better to create it manually:

```bash
docker network create proxy
```

* Uncomment line 80 and comment out line 81 of the `traefik.yml` file. Some Cloudflare users have encountered issues and had to disable the Proxy (orange cloud). In my case, this was not necessary.

* If we want to use the Traefik dashboard from outside our local network, we will have to create a CNAME record in our DNS provider that points to our domain. For example, `docker-compose.yml` shows that the panel will be available at `https://traefik.$DOMAINNAME`.

#### *Obtaining the Cloudflare API token*

* Go to the Cloudflare dashboard and click on your profile in the top right corner.
* In the left panel, click on "API Tokens" under "My Profile" section.
* Below, under "Create Custom Token" section, click on "Get Started".
* In "Token name" give it a name. The name doesn't matter it's only for your own reference.
* In "Permissions", you'll want "Zone → Zone → Read" and "Zone → DNS → Edit".
* In "Zone Resources" select "Include → Specific Zone" and enter your domain.
* Click on "Continue to summary".
* Then you will see a summary of the token creation process. Click on "Create Token".
* **CAUTION**: The code only appears once. If you don't copy it now for whatever reason, you must delete it and create a new one.
* Copy the token and paste it into the `CF_DNS_API_TOKEN` environment variable in `.env` file.

## Container start

```bash
# start Traefik in detached mode
docker compose up -d

# examine the logs to see if there are any problems (CTRL+c to exit)
docker logs traefik -f
```
</br>

The process of obtaining a certificate takes some time. After a few minutes, check the contents of `acme/acme.json` to see if we've obtained the test certificate. If so, revert lines 80 and 81 on `traefik.yml` file (comment out 80 and uncomment 81) and finally reset the acme/acme.json file with the following command:

```bash
: > acme/acme.json && chmod 600 acme/acme.json
```

**Important:** Both `:` and `>` are part of the command, so when copying it **make sure they aren't left out!**

Finally we start Traefik again:

```bash
# force to recreate the container from scratch
docker compose up -d --force-recreate
```

</br>

<h3>
	Ready! Now we can reach our services in our own domain with SSL certificates.
</h3>