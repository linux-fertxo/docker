<h1>
  <p align="center" width="100%">
	<img width="25%" src="../.recursos/img/traefik.png">
	</br></br>
	Træfik v3
  </p> 
</h1>

<h4> 
  <p align="center" width="100%">
A reverse proxy with SSL certificates to redirect incoming requests to their respective services through HTTPS  </p>
  </br>
</h4>

[![Static Badge](https://img.shields.io/badge/lang-%F0%9F%87%AA%F0%9F%87%B8_es-blue?style=plastic)](README.md)

##### Based on the image from [Traefik](https://traefik.io): [traefik](https://github.com/traefik/traefik)

- [Structure](#structure)
- [Explanation](#explanation)
	- [*Wait... What is a Middleware?*](#wait-what-is-a-middleware)
	- [*And a chain?*](#and-a-chain)
	- [*Other observations*](#other-observations)
	- [*Environment variables*](#environment-variables)
	- [*Before starting*](#before-starting)
- [Container start](#container-start)

#### Structure

	traefik/
	  ├─ docker-compose.yml                   → dockerfile
	  ├─ .env                                 → environment variables
	  ├─ traefik.yml                          → static configuration
	  ├─ acme/
	  │    └─ acme.json                       → SSL certificate
	  ├─ logs/
	  │    ├─ access.log                      → access log
	  │    └─ traefik.log                     → application log
	  └─ rules/                               → dynamic configuration
	       ├─ external.yml                    → redirection to non-docker services
	       ├─ middlewares.yml                 → middlewares (see below)
	       ├─ middlewares-chains.yml          → chained middlewares (see below)
	       └─ tls-opts.yml                    → TLS options

#### Explanation

The `docker-compose.yml` and `.env` files need no introduction, they are the files that contain all the instructions and variables to create the Traefik container.

The `traefik.yml` file contains the **_"static"_** Traefik configuration, that is, the configuration that does not change over time (or changes very rarely).

The `acme/` folder containing the `acme.json` file is where the SSL certificates generated by Let's Encrypt are stored. This file has special treatment, since we must create it manually and assign read and write permissions **only** to the user running the Traefik container, using `chmod 600 acme.json`

The `logs/` folder contains the access log files `access.log` and the Traefik application log files `traefik.log`. We can work without them, but it's recommended to have them on hand to debug problems or use them for other containers such as [**crowdsec**](../crowdsec), to look for suspicious behavior patterns. These files will also have to be created manually, since Docker is only capable of creating directories if necessary, but not files.

Finally, the `rules/` folder contains Traefik's **_"dynamic"_** configuration. Dynamic in the sense that each file we drop inside will be read by Traefik and will apply the configuration inside them. And dynamic in the sense that we can create new services (or delete them) with some regularity, as it's very likely to happen in a Homelab environment. Let's first talk about `external.yml` and `tls-opts.yml`, which are the easiest to explain.

* `external.yml`: Contains rules for redirecting incoming requests to services that are not Docker containers. For example, if we have a web service on a remote server, we can tell Traefik through these rules where each request should go. This file is actually an example of how to do it, since we can create a file for each service, one for all services, or a combination of both.
* `tls-opts.yml`: Contains a set of commonly used TLS options.

Among all the files inside `rules/` there are two that are of special importance: `middlewares` and `middlewares-chains`.

##### *Wait... What is a Middleware?*

Middlewares are pieces of code that are inserted between the request and the service. They are a way of "intercepting" incoming requests and making changes to them, which are usually necessary in order to make them understandable by the service and therefore make it work.

##### *And a chain?*

Services often use the same middlewares over and over again. A chain is a way of grouping them under the same name and thus applying them jointly to the service. Then we can specify the chain we want to be applied through Traefik labels.

##### *Other observations*

As we've seen, using the `rules/` folder allows us to drop files into it and have Traefik read and apply them on the fly. But this is not true for any subfolders we make inside, so it's not recursive. If we like to have everything organized and grouped by folders, it won't work.

The container uses [socket-proxy](../socket-proxy/) for added security, but there are the necessary lines (commented) to work without it.

It uses [Cloudflare](cloudflare.com) as a DNS resolver, but it is possible to use any other.

##### *Environment variables*

* `PUID` y `PGID` are the user and group identifiers in numeric format (run `id` to find out)
* `TZ` is the time zone in `Continent/City` format. [List of zones](https://www.joda.org/joda-time/timezones.html)
* `DOCKERDIR` is the parent directory containing all Docker services.
* `DOMAINNAME` is the name of our domain.
* `CLOUDFLARE_EMAIL` is the email address with which we registered the domain with Cloudflare.

##### *Before starting*

Create the folders and files structure indicated above, paying special attention to `acme.json`'s permissions. **If they are not 600 (rw- --- ---) Traefik won't start.**

The `proxy` network must be present before starting the Traefik container. You can comment out the `external: true` line in `docker-compose.yml` and Traefik will create it automatically, but this has the drawback that if the container fails or is not running, the other services that have it defined will also go down. That is why it is better to create it manually:

```bash
docker network create proxy
```

If we want to use the Traefik dashboard from outside our local network, we will have to create a CNAME record in our DNS provider that points to our domain. For example, `docker-compose.yml` shows that the panel will be available at `https://traefik.$DOMAINNAME`.

#### Container start

```bash
docker compose up -d     → start Traefik in background

docker logs traefik -f   → examine the log to check if there is any issue (CTRL+c for exit)
```
</br>

Ready! Now we can go to the services in our domain with SSL certificates.